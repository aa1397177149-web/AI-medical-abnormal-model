<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>医疗报告 AI 智能工作台 Pro</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>

    <style>
      @import url("https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap");
      :root {
        --primary-color: #4f46e5;
        --secondary-color: #818cf8;
        --success-color: #10b981;
        --danger-color: #ef4444;
        --warning-color: #f59e0b;
        --sidebar-width: 300px;
      }
      body {
        font-family: "Noto Sans SC", sans-serif;
        background-color: #eef2f6;
      }
      .sidebar {
        width: var(--sidebar-width);
        height: 100vh;
        background: white;
        position: fixed;
        left: 0;
        top: 0;
        z-index: 1000;
        box-shadow: 4px 0 15px rgba(0, 0, 0, 0.05);
        display: flex;
        flex-direction: column;
      }
      .sidebar-header {
        padding: 2rem 1.5rem;
        background: linear-gradient(
          135deg,
          var(--primary-color),
          var(--secondary-color)
        );
        color: white;
      }
      .sidebar-content {
        flex: 1;
        padding: 1.5rem;
        overflow-y: auto;
      }
      .import-box {
        border: 2px dashed #cbd5e1;
        border-radius: 12px;
        padding: 1.5rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
        background: #f8fafc;
        margin-bottom: 1.5rem;
      }
      .import-box:hover {
        border-color: var(--primary-color);
        background: #eef2ff;
      }
      .patient-list-item {
        padding: 1rem;
        border-radius: 10px;
        margin-bottom: 0.5rem;
        cursor: pointer;
        background: #f8fafc;
        border-left: 4px solid transparent;
        transition: all 0.2s;
      }
      .patient-list-item:hover {
        background: #f1f5f9;
      }
      .patient-list-item.active {
        background: white;
        border-left-color: var(--primary-color);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      }
      .main-content {
        margin-left: var(--sidebar-width);
        padding: 2rem;
        min-height: 100vh;
      }
      .report-paper {
        background: white;
        width: 210mm;
        min-height: 297mm;
        margin: 0 auto;
        padding: 20mm;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
      }
      .med-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
      }
      .med-table th {
        background: #f8fafc;
        padding: 12px;
        border-bottom: 2px solid #e2e8f0;
        font-size: 0.85rem;
        text-align: left;
      }
      .med-table td {
        padding: 12px;
        border-bottom: 1px solid #f1f5f9;
      }
      .badge-status {
        padding: 0.3em 0.7em;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        display: inline-block;
      }
      .bg-normal {
        background: #dcfce7;
        color: #166534;
      }
      .bg-abnormal {
        background: #fee2e2;
        color: #991b1b;
      }
      .bg-review {
        background: #fef3c7;
        color: #92400e;
      }
      .ai-insight {
        background: #f8fafc;
        border-radius: 12px;
        padding: 1.5rem;
        border-left: 4px solid var(--primary-color);
        margin-top: 2rem;
      }
      .floating-actions {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        z-index: 999;
      }
      .fab {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        border: none;
        color: white;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        transition: all 0.3s;
      }
      .fab:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
      }
      .fab:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .fab-bert {
        background: var(--primary-color);
      }
      .fab-llm {
        background: var(--success-color);
      }
      .connection-status {
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-size: 0.85rem;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      .status-connected {
        background: #dcfce7;
        color: #166534;
      }
      .status-disconnected {
        background: #fee2e2;
        color: #991b1b;
      }
      .status-checking {
        background: #fef3c7;
        color: #92400e;
      }
      .error-message {
        background: #fee2e2;
        color: #991b1b;
        padding: 1rem;
        border-radius: 8px;
        margin-top: 1rem;
        border-left: 4px solid var(--danger-color);
      }
      @media print {
        .sidebar,
        .floating-actions {
          display: none;
        }
        .main-content {
          margin-left: 0;
        }
      }
    </style>
  </head>

  <body>
    <div id="app">
      <div class="sidebar">
        <div class="sidebar-header">
          <div class="h5 m-0">
            <i class="fa-solid fa-staff-snake me-2"></i>MedAI Pro
          </div>
          <small>医疗报告智能工作台</small>
        </div>
        <div class="sidebar-content">
          <!-- 连接状态指示器 -->
          <div 
            :class="['connection-status', 
              connectionStatus === 'connected' ? 'status-connected' : 
              connectionStatus === 'disconnected' ? 'status-disconnected' : 
              'status-checking']"
          >
            <i class="fa-solid" :class="{
              'fa-circle-check': connectionStatus === 'connected',
              'fa-circle-xmark': connectionStatus === 'disconnected',
              'fa-spinner fa-spin': connectionStatus === 'checking'
            }"></i>
            <span>{{ connectionStatusText }}</span>
          </div>

          <input
            type="file"
            id="fileIn"
            class="d-none"
            @change="importExcel"
            accept=".xlsx,.xls,.csv"
          />
          <div
            class="import-box"
            onclick="document.getElementById('fileIn').click()"
          >
            <i class="fa-solid fa-file-excel fa-2x text-muted mb-2"></i>
            <div class="small fw-bold">导入 Excel 数据</div>
          </div>
          <div
            v-if="Object.keys(patients).length === 0"
            class="text-muted text-center small"
          >
            未导入患者数据
          </div>
          <div
            v-for="(p, id) in patients"
            :key="id"
            @click="currentId = id"
            :class="['patient-list-item', currentId === id ? 'active' : '']"
          >
            <div class="fw-bold">{{ p.name || '未知姓名' }}</div>
            <div class="text-muted small">{{ p.date || '未知日期' }}</div>
          </div>
        </div>
      </div>

      <div class="main-content">
        <div class="floating-actions" v-if="currentPatient">
          <button
            class="fab fab-bert"
            @click="runBERT"
            :disabled="isBertProcessing"
            title="BERT 诊断"
          >
            <i class="fa-solid fa-microscope" v-if="!isBertProcessing"></i>
            <span v-else class="spinner-border spinner-border-sm"></span>
          </button>
          <button
            class="fab fab-llm"
            @click="runLLM"
            :disabled="isLlmProcessing"
            title="Qwen 建议"
          >
            <i class="fa-solid fa-user-doctor" v-if="!isLlmProcessing"></i>
            <span v-else class="spinner-border spinner-border-sm"></span>
          </button>
        </div>

        <div v-if="currentPatient" class="report-paper">
          <h2 class="text-center mb-4">智慧医疗体检报告</h2>
          <div class="row bg-light p-3 rounded mb-4">
            <div class="col-4">
              <strong>姓名:</strong>{{ currentPatient.name || '-' }}
            </div>
            <div class="col-4">
              <strong>年龄:</strong>{{ currentPatient.age || '-' }}
            </div>
            <div class="col-4">
              <strong>日期:</strong>{{ currentPatient.date || '-' }}
            </div>
          </div>

          <div
            v-for="(items, gp) in currentPatient.groups"
            :key="gp"
            class="mb-4"
          >
            <h6 class="text-primary fw-bold border-bottom pb-2">{{ gp }}</h6>
            <table class="med-table">
              <thead>
                <tr>
                  <th>检查项目</th>
                  <th>结果</th>
                  <th>参考范围</th>
                  <th>AI 状态</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="item in items" :key="item.sub">
                  <td>{{ item.sub }}</td>
                  <td class="fw-bold">{{ item.res }}</td>
                  <td class="text-muted small">{{ item.ref || '--' }}</td>
                  <td>
                    <span :class="['badge-status', 'bg-' + item.status]"
                      >{{ item.statusLabel }}</span
                    >
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- 显示错误信息 -->
          <div v-if="errorMessage" class="error-message">
            <strong><i class="fa-solid fa-triangle-exclamation me-2"></i>错误:</strong>
            {{ errorMessage }}
          </div>

          <div v-if="currentPatient.summary" class="ai-insight">
            <h6>
              <i class="fa-solid fa-robot me-2"></i>AI 综合诊断建议 (Qwen 2.5)
            </h6>
            <div v-html="renderMD(currentPatient.summary)"></div>
          </div>
        </div>

        <div v-else class="text-center mt-5 text-muted">
          <i class="fa-regular fa-clipboard fa-4x mb-3"></i>
          <h4>请导入 Excel 数据并选择患者</h4>
        </div>
      </div>
    </div>

    <script>
      const { createApp, ref, computed, onMounted } = Vue;

      // ==================== 配置区 ====================
      // 重要: AutoDL 的公网地址必须使用 HTTPS
      const BERT_API = "https://u854272-a5b8-4f8246aa.westc.gpuhub.com:8443/api/predict";
      const BERT_HEALTH_API = "https://u854272-a5b8-4f8246aa.westc.gpuhub.com:8443/api/health";
      const OLLAMA_API = "http://localhost:11434/api/generate";
      
      // 请求配置
      const FETCH_TIMEOUT = 30000; // 30秒超时
      const MAX_RETRIES = 3; // 最大重试次数
      // ================================================

      createApp({
        setup() {
          const patients = ref({});
          const currentId = ref(null);
          const isBertProcessing = ref(false);
          const isLlmProcessing = ref(false);
          const connectionStatus = ref('checking'); // checking, connected, disconnected
          const errorMessage = ref('');

          const currentPatient = computed(
            () => patients.value[currentId.value] || null
          );

          const connectionStatusText = computed(() => {
            switch(connectionStatus.value) {
              case 'connected': return 'BERT 服务已连接';
              case 'disconnected': return 'BERT 服务未连接';
              case 'checking': return '检查连接中...';
              default: return '未知状态';
            }
          });

          // 带超时的 fetch 函数
          const fetchWithTimeout = async (url, options = {}, timeout = FETCH_TIMEOUT) => {
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), timeout);
            
            try {
              const response = await fetch(url, {
                ...options,
                signal: controller.signal
              });
              clearTimeout(id);
              return response;
            } catch (error) {
              clearTimeout(id);
              throw error;
            }
          };

          // 检查 BERT 服务连接
          const checkBertConnection = async () => {
            connectionStatus.value = 'checking';
            try {
              const response = await fetchWithTimeout(BERT_HEALTH_API, {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' }
              }, 5000);
              
              if (response.ok) {
                const data = await response.json();
                console.log('BERT 健康检查:', data);
                connectionStatus.value = 'connected';
                return true;
              } else {
                console.error('BERT 健康检查失败:', response.status);
                connectionStatus.value = 'disconnected';
                return false;
              }
            } catch (error) {
              console.error('BERT 连接错误:', error);
              connectionStatus.value = 'disconnected';
              return false;
            }
          };

          // 导入 Excel
          const importExcel = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            errorMessage.value = '';
            const reader = new FileReader();
            
            reader.onload = (ev) => {
              try {
                const wb = XLSX.read(new Uint8Array(ev.target.result), {
                  type: "array",
                });
                const json = XLSX.utils.sheet_to_json(
                  wb.Sheets[wb.SheetNames[0]]
                );
                
                const map = {};
                json.forEach((row) => {
                  const id = String(row["就诊ID"] || row["ID"] || "default");
                  if (!map[id]) {
                    map[id] = {
                      name: row["姓名"] || "未知",
                      age: row["年龄"] || "",
                      date: row["日期"] || "",
                      groups: {},
                      summary: "",
                    };
                  }
                  const gp = row["项目"] || "其他";
                  if (!map[id].groups[gp]) map[id].groups[gp] = [];
                  map[id].groups[gp].push({
                    sub: row["子项目"] || row["项目名称"] || "",
                    res: row["结果"] || "",
                    ref: row["参考值"] || row["参考范围"] || "",
                    type: row["类型"],
                    status: "review",
                    statusLabel: "待分析",
                  });
                });
                
                patients.value = map;
                if (Object.keys(map).length > 0 && !currentId.value) {
                  currentId.value = Object.keys(map)[0];
                }
                
                console.log(`成功导入 ${Object.keys(map).length} 位患者数据`);
              } catch (err) {
                console.error('Excel 解析错误:', err);
                errorMessage.value = `Excel 解析失败: ${err.message}`;
                alert(`Excel 解析失败: ${err.message}`);
              }
            };
            
            reader.onerror = (err) => {
              console.error('文件读取错误:', err);
              errorMessage.value = '文件读取失败';
              alert('文件读取失败');
            };
            
            reader.readAsArrayBuffer(file);
          };

          // BERT 预测（带重试）
          const runBERT = async () => {
            if (!currentPatient.value) return;
            
            // 先检查连接
            const isConnected = await checkBertConnection();
            if (!isConnected) {
              errorMessage.value = 'BERT 服务未连接，请检查服务器是否正常运行';
              alert('BERT 服务未连接，请检查:\n1. AutoDL 服务器是否运行\n2. 公网地址是否正确\n3. 端口映射是否配置');
              return;
            }
            
            isBertProcessing.value = true;
            errorMessage.value = '';
            
            const items = Object.values(currentPatient.value.groups).flat();
            const needPredict = items.filter(
              (i) => i.type === "检查" && i.status === "review"
            );

            console.log(`开始 BERT 分析，共 ${needPredict.length} 项`);
            
            let successCount = 0;
            let failCount = 0;

            for (let item of needPredict) {
              let retries = 0;
              let success = false;
              
              while (retries < MAX_RETRIES && !success) {
                try {
                  console.log(`预测: ${item.sub} = ${item.res} (第 ${retries + 1} 次尝试)`);
                  
                  const res = await fetchWithTimeout(BERT_API, {
                    method: "POST",
                    headers: { 
                      "Content-Type": "application/json",
                      "Accept": "application/json"
                    },
                    body: JSON.stringify({ text: item.res }),
                  });
                  
                  if (res.ok) {
                    const data = await res.json();
                    item.status = data.label;
                    item.statusLabel = data.label_cn;
                    console.log(`✓ 成功: ${item.sub} → ${data.label_cn}`);
                    successCount++;
                    success = true;
                  } else {
                    const errorText = await res.text();
                    console.error(`✗ HTTP ${res.status}:`, errorText);
                    item.statusLabel = `请求失败(${res.status})`;
                    retries++;
                  }
                } catch (e) {
                  console.error(`✗ 网络错误 (尝试 ${retries + 1}/${MAX_RETRIES}):`, e);
                  retries++;
                  
                  if (retries >= MAX_RETRIES) {
                    item.statusLabel = "网络错误";
                    failCount++;
                  } else {
                    // 等待后重试
                    await new Promise(resolve => setTimeout(resolve, 1000 * retries));
                  }
                }
              }
            }
            
            isBertProcessing.value = false;
            
            console.log(`BERT 分析完成: 成功 ${successCount}, 失败 ${failCount}`);
            
            if (failCount > 0) {
              errorMessage.value = `BERT 分析部分失败: ${failCount} 项未能完成`;
            }
          };

          // LLM 综合分析
          const runLLM = async () => {
            if (!currentPatient.value) return;
            
            isLlmProcessing.value = true;
            errorMessage.value = '';
            
            let prompt = `请分析以下体检报告,给出健康评估、异常解读、生活建议和复查提醒。用中文回复,语言专业且通俗易懂。\n\n`;
            Object.values(currentPatient.value.groups)
              .flat()
              .forEach((i) => {
                prompt += `- ${i.sub}: ${i.res} ${
                  i.ref ? "(" + i.ref + ")" : ""
                } [AI判定: ${i.statusLabel}]\n`;
              });

            try {
              console.log('开始 Qwen 分析...');
              const res = await fetchWithTimeout(OLLAMA_API, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  model: "qwen2.5",
                  prompt: prompt,
                  stream: false,
                }),
              });
              
              if (res.ok) {
                const data = await res.json();
                currentPatient.value.summary = data.response || "无回应";
                console.log('✓ Qwen 分析完成');
              } else {
                const errorText = await res.text();
                console.error('Qwen 请求失败:', res.status, errorText);
                currentPatient.value.summary = `Ollama 请求失败（状态码: ${res.status}）`;
                errorMessage.value = currentPatient.value.summary;
              }
            } catch (e) {
              console.error('Qwen 连接错误:', e);
              currentPatient.value.summary = "Ollama 连接失败，请检查:\n1. Ollama 是否在本地运行\n2. SSH 隧道是否建立\n3. 端口 11434 是否可访问";
              errorMessage.value = currentPatient.value.summary;
            }
            
            isLlmProcessing.value = false;
          };

          // 页面加载时检查连接
          onMounted(() => {
            console.log('应用启动，检查 BERT 连接...');
            checkBertConnection();
            
            // 每30秒自动检查一次连接
            setInterval(checkBertConnection, 30000);
          });

          return {
            patients,
            currentId,
            currentPatient,
            isBertProcessing,
            isLlmProcessing,
            connectionStatus,
            connectionStatusText,
            errorMessage,
            importExcel,
            runBERT,
            runLLM,
            renderMD: (t) => marked.parse(t || ""),
          };
        },
      }).mount("#app");
    </script>
  </body>
</html>